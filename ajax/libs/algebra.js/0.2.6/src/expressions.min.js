var Fraction=require("./fractions"),isInt=require("./helper").isInt,GREEK_LETTERS=require("./helper").GREEK_LETTERS,Expression=function(t){if(this.constants=[],"string"==typeof t){var e=new Variable(t),r=new Term(e);this.terms=[r]}else if(isInt(t))this.constants=[new Fraction(t,1)],this.terms=[];else if(t instanceof Fraction)this.constants=[t],this.terms=[];else if(t instanceof Term)this.terms=[t];else{if("undefined"!=typeof t)throw new TypeError("Invalid Argument ("+t.toString()+"): Argument must be of type String, Integer, Fraction or Term.");this.terms=[]}};Expression.prototype.constant=function(){return this.constants.reduce(function(t,e){return t.add(e)},new Fraction(0,1))},Expression.prototype.simplify=function(){var t=this.copy();return t.terms=t.terms.map(function(t){return t.simplify()}),t._sort(),t._combineLikeTerms(),t._moveTermsWithDegreeZeroToConstants(),t._removeTermsWithCoefficientZero(),t.constants=0===t.constant().valueOf()?[]:[t.constant()],t},Expression.prototype.copy=function(){var t=new Expression;return t.constants=this.constants.map(function(t){return t.copy()}),t.terms=this.terms.map(function(t){return t.copy()}),t},Expression.prototype.add=function(t,e){var r=this.copy();if("string"==typeof t||t instanceof Term||isInt(t)||t instanceof Fraction){var n=new Expression(t);return r.add(n,e)}if(!(t instanceof Expression))throw new TypeError("Invalid Argument ("+t.toString()+"): Summand must be of type String, Expression, Term, Fraction or Integer.");var i=t.copy().terms;return r.terms=r.terms.concat(i),r.constants=r.constants.concat(t.constants),r._sort(),e||void 0===e?r.simplify():r},Expression.prototype.subtract=function(t,e){var r=t instanceof Expression?t.multiply(-1):new Expression(t).multiply(-1);return this.add(r,e)},Expression.prototype.multiply=function(t,e){var r=this.copy();if("string"==typeof t||t instanceof Term||isInt(t)||t instanceof Fraction){var n=new Expression(t);return r.multiply(n,e)}if(!(t instanceof Expression))throw new TypeError("Invalid Argument ("+t.toString()+"): Multiplicand must be of type String, Expression, Term, Fraction or Integer.");for(var i=t.copy(),o=[],s=0;s<r.terms.length;s++){for(var a=r.terms[s],c=0;c<i.terms.length;c++){var f=i.terms[c];o.push(a.multiply(f,e))}for(var c=0;c<i.constants.length;c++)o.push(a.multiply(i.constants[c],e))}for(var s=0;s<i.terms.length;s++)for(var f=i.terms[s],c=0;c<r.constants.length;c++)o.push(f.multiply(r.constants[c],e));for(var u=[],s=0;s<r.constants.length;s++)for(var p=r.constants[s],c=0;c<i.constants.length;c++){var l=i.constants[c],h=new Term;h=h.multiply(l,!1),h=h.multiply(p,!1),o.push(h)}return r.constants=u,r.terms=o,r._sort(),e||void 0===e?r.simplify():r},Expression.prototype.divide=function(t,e){if(t instanceof Fraction||isInt(t)){if(0===t.valueOf())throw new EvalError("Divide By Zero");for(var r=this.copy(),n=0;n<r.terms.length;n++)for(var i=r.terms[n],o=0;o<i.coefficients.length;o++)i.coefficients[o]=i.coefficients[o].divide(t,e);return r.constants=r.constants.map(function(r){return r.divide(t,e)}),r}throw new TypeError("Invalid Argument ("+t.toString()+"): Divisor must be of type Fraction or Integer.")},Expression.prototype.pow=function(t,e){if(isInt(t)){var r=this.copy();if(0===t)return(new Expression).add(1);for(var n=1;t>n;n++)r=r.multiply(this,e);return r._sort(),e||void 0===e?r.simplify():r}throw new TypeError("Invalid Argument ("+t.toString()+"): Exponent must be of type Integer.")},Expression.prototype.eval=function(t,e){var r=new Expression;return r.constants=e?[this.constant()]:this.constants.slice(),r=this.terms.reduce(function(r,n){return r.add(n.eval(t,e),e)},r)},Expression.prototype.summation=function(t,e,r,n){for(var i=this.copy(),o=new Expression,s=e;r+1>s;s++){var a={};a[t]=s,o=o.add(i.eval(a,n),n)}return o},Expression.prototype.toString=function(){for(var t="",e=0;e<this.terms.length;e++){var r=this.terms[e];t+=(r.coefficients[0].valueOf()<0?" - ":" + ")+r.toString()}for(var e=0;e<this.constants.length;e++){var n=this.constants[e];t+=(n.valueOf()<0?" - ":" + ")+n.abs().toString()}return" - "===t.substring(0,3)?"-"+t.substring(3,t.length):" + "===t.substring(0,3)?t.substring(3,t.length):"0"},Expression.prototype.toTex=function(t){for(var e="",r=0;r<this.terms.length;r++){var n=this.terms[r];e+=(n.coefficients[0].valueOf()<0?" - ":" + ")+n.toTex(t)}for(var r=0;r<this.constants.length;r++){var i=this.constants[r];e+=(i.valueOf()<0?" - ":" + ")+i.abs().toTex()}return" - "===e.substring(0,3)?"-"+e.substring(3,e.length):" + "===e.substring(0,3)?e.substring(3,e.length):"0"},Expression.prototype._removeTermsWithCoefficientZero=function(){return this.terms=this.terms.filter(function(t){return 0!==t.coefficient().reduce().numer}),this},Expression.prototype._combineLikeTerms=function(){function t(t,e){for(var r=0;r<e.length;r++)if(t.canBeCombinedWith(e[r]))return!0;return!1}for(var e=[],r=[],n=0;n<this.terms.length;n++){var i=this.terms[n];if(!t(i,r)){for(var o=n+1;o<this.terms.length;o++){var s=this.terms[o];i.canBeCombinedWith(s)&&(i=i.add(s))}e.push(i),r.push(i)}}return this.terms=e,this},Expression.prototype._moveTermsWithDegreeZeroToConstants=function(){for(var t=[],e=new Fraction(0,1),r=0;r<this.terms.length;r++){var n=this.terms[r];0===n.variables.length?e=e.add(n.coefficient()):t.push(n)}return this.constants.push(e),this.terms=t,this},Expression.prototype._sort=function(){function t(t,e){var r=t.maxDegree(),n=e.maxDegree();if(r===n){var i=t.variables.length,o=e.variables.length;return o-i}return n-r}return this.terms=this.terms.sort(t),this},Expression.prototype._hasVariable=function(t){for(var e=0;e<this.terms.length;e++)if(this.terms[e].hasVariable(t))return!0;return!1},Expression.prototype._onlyHasVariable=function(t){for(var e=0;e<this.terms.length;e++)if(!this.terms[e].onlyHasVariable(t))return!1;return!0},Expression.prototype._noCrossProductsWithVariable=function(t){for(var e=0;e<this.terms.length;e++){var r=this.terms[e];if(r.hasVariable(t)&&!r.onlyHasVariable(t))return!1}return!0},Expression.prototype._noCrossProducts=function(){for(var t=0;t<this.terms.length;t++){var e=this.terms[t];if(e.variables.length>1)return!1}return!0},Expression.prototype._maxDegree=function(){return this.terms.reduce(function(t,e){return Math.max(t,e.maxDegree())},1)},Expression.prototype._maxDegreeOfVariable=function(t){return this.terms.reduce(function(e,r){return Math.max(e,r.maxDegreeOfVariable(t))},1)},Expression.prototype._quadraticCoefficients=function(){for(var t,e=new Fraction(0,1),r=0;r<this.terms.length;r++){var n=this.terms[r];t=2===n.maxDegree()?n.coefficient().copy():t,e=1===n.maxDegree()?n.coefficient().copy():e}var i=this.constant();return{a:t,b:e,c:i}},Expression.prototype._cubicCoefficients=function(){for(var t,e=new Fraction(0,1),r=new Fraction(0,1),n=0;n<this.terms.length;n++){var i=this.terms[n];t=3===i.maxDegree()?i.coefficient().copy():t,e=2===i.maxDegree()?i.coefficient().copy():e,r=1===i.maxDegree()?i.coefficient().copy():r}var o=this.constant();return{a:t,b:e,c:r,d:o}},Term=function(t){if(t instanceof Variable)this.variables=[t.copy()];else{if("undefined"!=typeof t)throw new TypeError("Invalid Argument ("+t.toString()+"): Term initializer must be of type Variable.");this.variables=[]}this.coefficients=[new Fraction(1,1)]},Term.prototype.coefficient=function(){return this.coefficients.reduce(function(t,e){return t.multiply(e)},new Fraction(1,1))},Term.prototype.simplify=function(){var t=this.copy();return t.coefficients=[this.coefficient()],t.combineVars(),t.sort()},Term.prototype.combineVars=function(){for(var t={},e=0;e<this.variables.length;e++){var r=this.variables[e];r.variable in t?t[r.variable]+=r.degree:t[r.variable]=r.degree}var n=[];for(var i in t){var o=new Variable(i);o.degree=t[i],n.push(o)}return this.variables=n,this},Term.prototype.copy=function(){var t=new Term;return t.coefficients=this.coefficients.map(function(t){return t.copy()}),t.variables=this.variables.map(function(t){return t.copy()}),t},Term.prototype.add=function(t){if(t instanceof Term&&this.canBeCombinedWith(t)){var e=this.copy();return e.coefficients=[e.coefficient().add(t.coefficient())],e}throw new TypeError("Invalid Argument ("+t.toString()+"): Summand must be of type String, Expression, Term, Fraction or Integer.")},Term.prototype.subtract=function(t){if(t instanceof Term&&this.canBeCombinedWith(t)){var e=this.copy();return e.coefficients=[e.coefficient().subtract(t.coefficient())],e}throw new TypeError("Invalid Argument ("+t.toString()+"): Subtrahend must be of type String, Expression, Term, Fraction or Integer.")},Term.prototype.multiply=function(t,e){var r=this.copy();if(t instanceof Term)r.variables=r.variables.concat(t.variables),r.coefficients=t.coefficients.concat(r.coefficients);else{if(!(isInt(t)||t instanceof Fraction))throw new TypeError("Invalid Argument ("+t.toString()+"): Multiplicand must be of type String, Expression, Term, Fraction or Integer.");var n=isInt(t)?new Fraction(t,1):t;0===r.variables.length?r.coefficients.push(n):r.coefficients.unshift(n)}return e||void 0===e?r.simplify():r},Term.prototype.divide=function(t,e){if(isInt(t)||t instanceof Fraction){var r=this.copy();return r.coefficients=r.coefficients.map(function(r){return r.divide(t,e)}),r}throw new TypeError("Invalid Argument ("+t.toString()+"): Argument must be of type Fraction or Integer.")},Term.prototype.eval=function(t,e){for(var r=this.copy(),n=(Object.keys(t),r.coefficients.reduce(function(t,r){return t.multiply(r,e)},new Expression(1))),i=0;i<r.variables.length;i++){var o,s=r.variables[i];if(s.variable in t){var a=t[s.variable];if(a instanceof Fraction||a instanceof Expression)o=a.pow(s.degree);else{if(!isInt(a))throw new TypeError("Invalid Argument ("+a+"): Can only evaluate Expressions or Fractions.");o=Math.pow(a,s.degree)}}else o=new Expression(s.variable).pow(s.degree);n=n.multiply(o,e)}return n},Term.prototype.hasVariable=function(t){for(var e=0;e<this.variables.length;e++)if(this.variables[e].variable===t)return!0;return!1},Term.prototype.maxDegree=function(){return this.variables.reduce(function(t,e){return Math.max(t,e.degree)},1)},Term.prototype.maxDegreeOfVariable=function(t){return this.variables.reduce(function(e,r){return r.variable===t?Math.max(e,r.degree):e},1)},Term.prototype.canBeCombinedWith=function(t){var e=this.variables,r=t.variables;if(e.length!=r.length)return!1;for(var n=0,i=0;i<e.length;i++)for(var o=0;o<r.length;o++)e[i].variable===r[o].variable&&e[i].degree===r[o].degree&&(n+=1);return n===e.length},Term.prototype.onlyHasVariable=function(t){for(var e=0;e<this.variables.length;e++)if(this.variables[e].variable!=t)return!1;return!0},Term.prototype.sort=function(){function t(t,e){return e.degree-t.degree}return this.variables=this.variables.sort(t),this},Term.prototype.toString=function(){for(var t="",e=0;e<this.coefficients.length;e++){var r=this.coefficients[e];(1!==r.abs().numer||1!==r.abs().denom)&&(t+=" * "+r.toString())}return t=this.variables.reduce(function(t,e){return t.concat(e.toString())},t),t=" * "===t.substring(0,3)?t.substring(3,t.length):t,t="-"===t.substring(0,1)?t.substring(1,t.length):t},Term.prototype.toTex=function(t){var t=void 0===t?{}:t;t.multiplication="multiplication"in t?t.multiplication:"cdot";for(var e=" \\"+t.multiplication+" ",r="",n=0;n<this.coefficients.length;n++){var i=this.coefficients[n];(1!==i.abs().numer||1!==i.abs().denom)&&(r+=e+i.toTex())}return r=this.variables.reduce(function(t,e){return t.concat(e.toTex())},r),r=r.substring(0,e.length)===e?r.substring(e.length,r.length):r,r="-"===r.substring(0,1)?r.substring(1,r.length):r,r="\\frac{-"===r.substring(0,7)?"\\frac{"+r.substring(7,r.length):r};var Variable=function(t){if("string"!=typeof t)throw new TypeError("Invalid Argument ("+t.toString()+"): Variable initalizer must be of type String.");this.variable=t,this.degree=1};Variable.prototype.copy=function(){var t=new Variable(this.variable);return t.degree=this.degree,t},Variable.prototype.toString=function(){var t=this.degree,e=this.variable;return 0===t?"":1===t?e:e+"^"+t},Variable.prototype.toTex=function(){var t=this.degree,e=this.variable;return GREEK_LETTERS.indexOf(e)>-1&&(e="\\"+e),0===t?"":1===t?e:e+"^{"+t+"}"},module.exports={Expression:Expression,Term:Term,Variable:Variable};
